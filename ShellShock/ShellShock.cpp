#include <cstdio>
#include <fstream>

#include "Windows.h"
#include "HexDump.h"

VOID ConvertToShellcode(LPSTR& outBytes, DWORD& outLength, BOOL bIs64Bit)
{
	//MARKER:S
    LPSTR shellCodeA32 = const_cast<LPSTR>("\x83\xEC\x60\x53\x55\x56\x57\x6A\x75\x58\x6A\x73\x59\x6A\x65\x5B\x6A\x72\x5F\x6A\x33\x66\x89\x44\x24\x44\x58\x6A\x32\x66\x89\x44\x24\x4C\x58\x6A\x2E\x66\x89\x44\x24\x4E\x58\x6A\x64\x5E\x6A\x6C\x5A\x6A\x6F\x83\x64\x24\x14\x00\x66\x89\x5C\x24\x48\x88\x5C\x24\x2D\x88\x5C\x24\x32\x5B\x6A\x57\x66\x89\x4C\x24\x46\x66\x89\x44\x24\x50\x88\x4C\x24\x2E\x88\x4C\x24\x2F\x59\x6A\x48\x58\x6A\x65\x5D\x6A\x20\x66\x89\x44\x24\x58\x58\x6A\x21\x66\x89\x44\x24\x62\x33\xC0\x88\x4C\x24\x36\x66\x89\x4C\x24\x64\x59\x6A\x44\x66\x89\x44\x24\x70\x58\x66\x89\x44\x24\x34\x6A\x6D\x58\x66\x89\x44\x24\x38\x33\xC0\x66\x89\x7C\x24\x46\x66\x89\x74\x24\x4E\x66\x89\x54\x24\x50\x66\x89\x54\x24\x52\xC6\x44\x24\x28\x4D\x66\xC7\x44\x24\x2C\x61\x67\xC6\x44\x24\x2F\x42\x88\x5C\x24\x30\xC6\x44\x24\x31\x78\xC6\x44\x24\x33\x00\x66\x89\x6C\x24\x56\x66\x89\x54\x24\x58\x66\x89\x54\x24\x5A\x66\x89\x5C\x24\x5C\x66\x89\x5C\x24\x62\x66\x89\x7C\x24\x64\x66\x89\x54\x24\x66\x66\x89\x74\x24\x68\x66\x89\x4C\x24\x6A\x66\x89\x6C\x24\x36\x66\x89\x5C\x24\x3A\x66\x89\x4C\x24\x3C\x66\x89\x44\x24\x3E\xB9\x13\x9C\xBF\xBD\xE8\x71\x00\x00\x00\xB9\xB5\x41\xD9\x5E\x8B\xF0\xE8\x65\x00\x00\x00\x8B\xF8\x33\xDB\x6A\x14\x8D\x44\x24\x44\x89\x44\x24\x20\x58\x66\x89\x44\x24\x1A\x66\x89\x44\x24\x18\x8D\x44\x24\x14\x50\x8D\x44\x24\x1C\x50\x53\x53\xFF\xD6\x6A\x0C\x58\x66\x89\x44\x24\x20\x66\x89\x44\x24\x22\x8D\x44\x24\x28\x89\x44\x24\x24\x8D\x44\x24\x10\x50\x53\x8D\x44\x24\x28\x50\xFF\x74\x24\x20\xFF\xD7\x53\x8D\x44\x24\x38\x50\x8D\x44\x24\x5C\x50\x53\xFF\x54\x24\x20\x5F\x5E\x5D\x5B\x83\xC4\x60\xC3\x83\xEC\x18\x64\xA1\x30\x00\x00\x00\x53\x55\x56\x8B\x40\x0C\x57\x89\x4C\x24\x20\x8B\x70\x0C\xE9\xA9\x00\x00\x00\x8B\x56\x18\x33\xFF\x8B\x46\x30\x8B\x6E\x2C\x8B\x36\x89\x44\x24\x1C\x8B\x42\x3C\x89\x54\x24\x10\x8B\x5C\x10\x78\x89\x5C\x24\x14\x85\xDB\x0F\x84\x81\x00\x00\x00\x21\x7C\x24\x18\xC1\xED\x10\x85\xED\x74\x28\x8B\x54\x24\x18\x8B\x5C\x24\x1C\x0F\xBE\x04\x13\xC1\xCF\x0D\x03\xC7\x80\x3C\x13\x61\x8D\x78\xE0\x0F\x4C\xF8\x42\x3B\xD5\x72\xE8\x8B\x54\x24\x10\x8B\x5C\x24\x14\x8B\x44\x13\x20\x33\xED\x8B\x4C\x13\x18\x03\xC2\x89\x4C\x24\x18\x85\xC9\x74\x3A\x8B\x08\x33\xDB\x03\xCA\x83\xC0\x04\x89\x4C\x24\x1C\x8B\xD1\x89\x44\x24\x24\x8A\x0A\xC1\xCB\x0D\x0F\xBE\xC1\x03\xD8\x42\x84\xC9\x75\xF1\x8B\x54\x24\x10\x8D\x04\x3B\x3B\x44\x24\x20\x74\x1F\x8B\x44\x24\x24\x45\x3B\x6C\x24\x18\x72\xC6\x83\x7E\x18\x00\x0F\x85\x4D\xFF\xFF\xFF\x33\xC0\x5F\x5E\x5D\x5B\x83\xC4\x18\xC3\x8B\x74\x24\x14\x8B\x44\x16\x24\x8D\x04\x68\x0F\xB7\x0C\x10\x8B\x44\x16\x1C\x8D\x04\x88\x8B\x04\x10\x03\xC2\xEB\xDB");
    LPSTR shellCodeA64 = const_cast<LPSTR>("\x48\x89\x5C\x24\x18\x48\x89\x7C\x24\x20\x55\x48\x8D\x6C\x24\xA9\x48\x81\xEC\xA0\x00\x00\x00\x33\xDB\xC7\x45\x17\x75\x00\x73\x00\xB9\x13\x9C\xBF\xBD\x48\x89\x5D\x67\x89\x5D\xFB\x89\x5D\x0B\x66\x89\x5D\x47\xC7\x45\x1B\x65\x00\x72\x00\xC7\x45\x1F\x33\x00\x32\x00\xC7\x45\x23\x2E\x00\x64\x00\xC7\x45\x27\x6C\x00\x6C\x00\xC7\x45\xD7\x4D\x65\x73\x73\xC7\x45\xDB\x61\x67\x65\x42\xC7\x45\xDF\x6F\x78\x57\x00\xC7\x45\x2F\x48\x00\x65\x00\xC7\x45\x33\x6C\x00\x6C\x00\xC7\x45\x37\x6F\x00\x20\x00\xC7\x45\x3B\x57\x00\x6F\x00\xC7\x45\x3F\x72\x00\x6C\x00\xC7\x45\x43\x64\x00\x21\x00\xC7\x45\xE7\x44\x00\x65\x00\xC7\x45\xEB\x6D\x00\x6F\x00\xC7\x45\xEF\x21\x00\x00\x00\xE8\x74\x00\x00\x00\xB9\xB5\x41\xD9\x5E\x48\x8B\xD8\xE8\x67\x00\x00\x00\x48\x8B\xF8\xC7\x45\xF7\x14\x00\x14\x00\x48\x8D\x45\x17\x33\xD2\x4C\x8D\x4D\x6F\x48\x89\x45\xFF\x4C\x8D\x45\xF7\x33\xC9\xFF\xD3\x48\x8B\x4D\x6F\x48\x8D\x45\xD7\x45\x33\xC0\x48\x89\x45\x0F\x4C\x8D\x4D\x67\xC7\x45\x07\x0C\x00\x0C\x00\x48\x8D\x55\x07\xFF\xD7\x45\x33\xC9\x4C\x8D\x45\xE7\x48\x8D\x55\x2F\x33\xC9\xFF\x55\x67\x4C\x8D\x9C\x24\xA0\x00\x00\x00\x49\x8B\x5B\x20\x49\x8B\x7B\x28\x49\x8B\xE3\x5D\xC3\xCC\xCC\x48\x8B\xC4\x48\x89\x58\x08\x48\x89\x68\x10\x48\x89\x70\x18\x48\x89\x78\x20\x41\x56\x65\x48\x8B\x04\x25\x60\x00\x00\x00\x8B\xE9\x45\x33\xF6\x48\x8B\x50\x18\x4C\x8B\x4A\x10\xE9\x96\x00\x00\x00\x4D\x8B\x41\x30\x41\x8B\xD6\x41\x0F\x10\x41\x58\x4D\x8B\x09\x49\x63\x40\x3C\x46\x8B\x94\x00\x88\x00\x00\x00\x45\x85\xD2\x74\x76\x66\x48\x0F\x7E\xC0\x48\xC1\xE8\x10\x66\x44\x3B\xF0\x73\x29\x66\x0F\x73\xD8\x08\x66\x49\x0F\x7E\xC3\x0F\xB7\xD8\x41\x0F\xBE\x0B\xC1\xCA\x0D\x03\xCA\x41\x80\x3B\x61\x8D\x51\xE0\x0F\x4C\xD1\x49\xFF\xC3\x48\x83\xEB\x01\x75\xE4\x4D\x03\xD0\x45\x8B\xDE\x41\x8B\x7A\x20\x49\x03\xF8\x45\x39\x72\x18\x76\x2B\x8B\x37\x41\x8B\xDE\x49\x03\xF0\x48\x8D\x7F\x04\x0F\xBE\x0E\x48\xFF\xC6\xC1\xCB\x0D\x03\xD9\x84\xC9\x75\xF1\x8D\x04\x13\x3B\xC5\x74\x2C\x41\xFF\xC3\x45\x3B\x5A\x18\x72\xD5\x4D\x39\x71\x30\x0F\x85\x60\xFF\xFF\xFF\x33\xC0\x48\x8B\x5C\x24\x10\x48\x8B\x6C\x24\x18\x48\x8B\x74\x24\x20\x48\x8B\x7C\x24\x28\x41\x5E\xC3\x41\x8B\x42\x24\x43\x8D\x0C\x1B\x49\x03\xC0\x0F\xB7\x14\x01\x41\x8B\x4A\x1C\x49\x03\xC8\x8B\x04\x91\x49\x03\xC0\xEB\xCB");
    LPSTR shellCodeB32 = const_cast<LPSTR>("\x83\xEC\x64\x53\x55\x56\x57\x6A\x75\x58\x6A\x73\x59\x6A\x65\x5B\x6A\x72\x5F\x6A\x33\x66\x89\x44\x24\x44\x58\x6A\x32\x66\x89\x44\x24\x4C\x58\x6A\x2E\x66\x89\x44\x24\x4E\x58\x6A\x64\x5E\x6A\x6C\x5A\x6A\x6F\x83\x64\x24\x14\x00\x66\x89\x5C\x24\x48\x88\x5C\x24\x2D\x88\x5C\x24\x32\x5B\x6A\x57\x66\x89\x4C\x24\x46\x66\x89\x44\x24\x50\x88\x4C\x24\x2E\x88\x4C\x24\x2F\x59\x6A\x47\x58\x6A\x62\x66\x89\x44\x24\x58\x58\x6A\x79\x66\x89\x44\x24\x60\x58\x6A\x65\x5D\x6A\x20\x66\x89\x44\x24\x62\x58\x6A\x21\x88\x4C\x24\x36\x66\x89\x44\x24\x66\x33\xC0\x66\x89\x4C\x24\x68\x59\x6A\x44\x66\x89\x44\x24\x74\x58\x66\x89\x7C\x24\x46\x66\x89\x74\x24\x4E\x66\x89\x54\x24\x50\x66\x89\x54\x24\x52\xC6\x44\x24\x28\x4D\x66\xC7\x44\x24\x2C\x61\x67\xC6\x44\x24\x2F\x42\x88\x5C\x24\x30\xC6\x44\x24\x31\x78\xC6\x44\x24\x33\x00\x66\x89\x5C\x24\x56\x66\x89\x5C\x24\x58\x66\x89\x74\x24\x5A\x66\x89\x6C\x24\x60\x66\x89\x5C\x24\x66\x66\x89\x7C\x24\x68\x66\x89\x54\x24\x6A\x66\x89\x74\x24\x6C\x66\x89\x4C\x24\x6E\x66\x89\x44\x24\x34\x66\x89\x6C\x24\x36\x6A\x6D\x58\x66\x89\x44\x24\x38\x33\xC0\x66\x89\x4C\x24\x3C\xB9\x13\x9C\xBF\xBD\x66\x89\x5C\x24\x3A\x66\x89\x44\x24\x3E\xE8\x71\x00\x00\x00\xB9\xB5\x41\xD9\x5E\x8B\xF0\xE8\x65\x00\x00\x00\x8B\xF8\x33\xDB\x6A\x14\x8D\x44\x24\x44\x89\x44\x24\x20\x58\x66\x89\x44\x24\x1A\x66\x89\x44\x24\x18\x8D\x44\x24\x14\x50\x8D\x44\x24\x1C\x50\x53\x53\xFF\xD6\x6A\x0C\x58\x66\x89\x44\x24\x20\x66\x89\x44\x24\x22\x8D\x44\x24\x28\x89\x44\x24\x24\x8D\x44\x24\x10\x50\x53\x8D\x44\x24\x28\x50\xFF\x74\x24\x20\xFF\xD7\x53\x8D\x44\x24\x38\x50\x8D\x44\x24\x5C\x50\x53\xFF\x54\x24\x20\x5F\x5E\x5D\x5B\x83\xC4\x64\xC3\x83\xEC\x18\x64\xA1\x30\x00\x00\x00\x53\x55\x56\x8B\x40\x0C\x57\x89\x4C\x24\x20\x8B\x70\x0C\xE9\xA9\x00\x00\x00\x8B\x56\x18\x33\xFF\x8B\x46\x30\x8B\x6E\x2C\x8B\x36\x89\x44\x24\x1C\x8B\x42\x3C\x89\x54\x24\x10\x8B\x5C\x10\x78\x89\x5C\x24\x14\x85\xDB\x0F\x84\x81\x00\x00\x00\x21\x7C\x24\x18\xC1\xED\x10\x85\xED\x74\x28\x8B\x54\x24\x18\x8B\x5C\x24\x1C\x0F\xBE\x04\x13\xC1\xCF\x0D\x03\xC7\x80\x3C\x13\x61\x8D\x78\xE0\x0F\x4C\xF8\x42\x3B\xD5\x72\xE8\x8B\x54\x24\x10\x8B\x5C\x24\x14\x8B\x44\x13\x20\x33\xED\x8B\x4C\x13\x18\x03\xC2\x89\x4C\x24\x18\x85\xC9\x74\x3A\x8B\x08\x33\xDB\x03\xCA\x83\xC0\x04\x89\x4C\x24\x1C\x8B\xD1\x89\x44\x24\x24\x8A\x0A\xC1\xCB\x0D\x0F\xBE\xC1\x03\xD8\x42\x84\xC9\x75\xF1\x8B\x54\x24\x10\x8D\x04\x3B\x3B\x44\x24\x20\x74\x1F\x8B\x44\x24\x24\x45\x3B\x6C\x24\x18\x72\xC6\x83\x7E\x18\x00\x0F\x85\x4D\xFF\xFF\xFF\x33\xC0\x5F\x5E\x5D\x5B\x83\xC4\x18\xC3\x8B\x74\x24\x14\x8B\x44\x16\x24\x8D\x04\x68\x0F\xB7\x0C\x10\x8B\x44\x16\x1C\x8D\x04\x88\x8B\x04\x10\x03\xC2\xEB\xDB");
    LPSTR shellCodeB64 = const_cast<LPSTR>("\x48\x89\x5C\x24\x18\x48\x89\x7C\x24\x20\x55\x48\x8D\x6C\x24\xA9\x48\x81\xEC\xA0\x00\x00\x00\x33\xDB\xC7\x45\x17\x75\x00\x73\x00\xB9\x13\x9C\xBF\xBD\x48\x89\x5D\x67\x89\x5D\xFB\x89\x5D\x0B\x66\x89\x5D\x4B\xC7\x45\x1B\x65\x00\x72\x00\xC7\x45\x1F\x33\x00\x32\x00\xC7\x45\x23\x2E\x00\x64\x00\xC7\x45\x27\x6C\x00\x6C\x00\xC7\x45\xD7\x4D\x65\x73\x73\xC7\x45\xDB\x61\x67\x65\x42\xC7\x45\xDF\x6F\x78\x57\x00\xC7\x45\x2F\x47\x00\x6F\x00\xC7\x45\x33\x6F\x00\x64\x00\xC7\x45\x37\x62\x00\x79\x00\xC7\x45\x3B\x65\x00\x20\x00\xC7\x45\x3F\x57\x00\x6F\x00\xC7\x45\x43\x72\x00\x6C\x00\xC7\x45\x47\x64\x00\x21\x00\xC7\x45\xE7\x44\x00\x65\x00\xC7\x45\xEB\x6D\x00\x6F\x00\xC7\x45\xEF\x21\x00\x00\x00\xE8\x75\x00\x00\x00\xB9\xB5\x41\xD9\x5E\x48\x8B\xD8\xE8\x68\x00\x00\x00\x48\x8B\xF8\xC7\x45\xF7\x14\x00\x14\x00\x48\x8D\x45\x17\x33\xD2\x4C\x8D\x4D\x6F\x48\x89\x45\xFF\x4C\x8D\x45\xF7\x33\xC9\xFF\xD3\x48\x8B\x4D\x6F\x48\x8D\x45\xD7\x45\x33\xC0\x48\x89\x45\x0F\x4C\x8D\x4D\x67\xC7\x45\x07\x0C\x00\x0C\x00\x48\x8D\x55\x07\xFF\xD7\x45\x33\xC9\x4C\x8D\x45\xE7\x48\x8D\x55\x2F\x33\xC9\xFF\x55\x67\x4C\x8D\x9C\x24\xA0\x00\x00\x00\x49\x8B\x5B\x20\x49\x8B\x7B\x28\x49\x8B\xE3\x5D\xC3\xCC\xCC\xCC\x48\x8B\xC4\x48\x89\x58\x08\x48\x89\x68\x10\x48\x89\x70\x18\x48\x89\x78\x20\x41\x56\x65\x48\x8B\x04\x25\x60\x00\x00\x00\x8B\xE9\x45\x33\xF6\x48\x8B\x50\x18\x4C\x8B\x4A\x10\xE9\x96\x00\x00\x00\x4D\x8B\x41\x30\x41\x8B\xD6\x41\x0F\x10\x41\x58\x4D\x8B\x09\x49\x63\x40\x3C\x46\x8B\x94\x00\x88\x00\x00\x00\x45\x85\xD2\x74\x76\x66\x48\x0F\x7E\xC0\x48\xC1\xE8\x10\x66\x44\x3B\xF0\x73\x29\x66\x0F\x73\xD8\x08\x66\x49\x0F\x7E\xC3\x0F\xB7\xD8\x41\x0F\xBE\x0B\xC1\xCA\x0D\x03\xCA\x41\x80\x3B\x61\x8D\x51\xE0\x0F\x4C\xD1\x49\xFF\xC3\x48\x83\xEB\x01\x75\xE4\x4D\x03\xD0\x45\x8B\xDE\x41\x8B\x7A\x20\x49\x03\xF8\x45\x39\x72\x18\x76\x2B\x8B\x37\x41\x8B\xDE\x49\x03\xF0\x48\x8D\x7F\x04\x0F\xBE\x0E\x48\xFF\xC6\xC1\xCB\x0D\x03\xD9\x84\xC9\x75\xF1\x8D\x04\x13\x3B\xC5\x74\x2C\x41\xFF\xC3\x45\x3B\x5A\x18\x72\xD5\x4D\x39\x71\x30\x0F\x85\x60\xFF\xFF\xFF\x33\xC0\x48\x8B\x5C\x24\x10\x48\x8B\x6C\x24\x18\x48\x8B\x74\x24\x20\x48\x8B\x7C\x24\x28\x41\x5E\xC3\x41\x8B\x42\x24\x43\x8D\x0C\x1B\x49\x03\xC0\x0F\xB7\x14\x01\x41\x8B\x4A\x1C\x49\x03\xC8\x8B\x04\x91\x49\x03\xC0\xEB\xCB");
    DWORD shellCodeA32Length = 632, shellCodeA64Length = 547;
    DWORD shellCodeB32Length = 648, shellCodeB64Length = 555;
    //MARKER:E

	// Determine which shellcode to use based on architecture
	LPSTR shellcodeA = (bIs64Bit) ? shellCodeA64 : shellCodeA32;
	LPSTR shellcodeB = (bIs64Bit) ? shellCodeB64 : shellCodeB32;
	DWORD shellcodeALength = (bIs64Bit) ? shellCodeA64Length : shellCodeA32Length;
	DWORD shellcodeBLength = (bIs64Bit) ? shellCodeB64Length : shellCodeB32Length;

	BYTE bootstrap[20] = { 0 };
	DWORD i = 0;
	
	// call - Transfer execution to shellCodeA
	bootstrap[i++] = 0xe8;
	ptrdiff_t shellcodeAOffset = sizeof(bootstrap) - i - 4;  // 4 bytes for the call instruction
	bootstrap[i++] = (BYTE)shellcodeAOffset;
	bootstrap[i++] = (BYTE)(shellcodeAOffset >> 8);
	bootstrap[i++] = (BYTE)(shellcodeAOffset >> 16);
	bootstrap[i++] = (BYTE)(shellcodeAOffset >> 24);  // 32 bit address space

	// call - Transfer execution to shellCodeB
	bootstrap[i++] = 0xe8;
	ptrdiff_t shellcodeBOffset = sizeof(bootstrap) + shellcodeALength - i - 4;  // 4 bytes for the call instruction
	bootstrap[i++] = (BYTE)shellcodeBOffset;
	bootstrap[i++] = (BYTE)(shellcodeBOffset >> 8);
	bootstrap[i++] = (BYTE)(shellcodeBOffset >> 16);
	bootstrap[i++] = (BYTE)(shellcodeBOffset >> 24);  // 32 bit address space

	printf("ShellcodeA offset: %d\n", shellcodeAOffset);
	printf("ShellcodeB offset: %d\n", shellcodeBOffset);
	printf("Bootstrap: \n");
	HexDump(bootstrap, i);
	
	//// leave
	//bootstrap[i++] = 0xc9;

	// ret - return to caller
	bootstrap[i++] = 0xc3;
	
	// Ends up looking like this in memory:
	// Bootstrap shellcode
	// shellCodeA
	// shellCodeB
	// ret
	outLength = sizeof(bootstrap) + shellcodeALength + shellcodeBLength;
	outBytes = (LPSTR)malloc(outLength);
	//MoveMemory(outBytes, bootstrap, sizeof(bootstrap));
	MoveMemory(outBytes, bootstrap, i);
	MoveMemory(outBytes + sizeof(bootstrap), shellcodeA, shellcodeALength);
	MoveMemory(outBytes + sizeof(bootstrap) + shellcodeALength, shellcodeB, shellcodeBLength);
}

typedef VOID(WINAPI* SHC)();

int main()
{
	///
	// Create shellcode
	///
	LPSTR			finalShellcode = NULL;
	DWORD			finalSize = 0;
	
#ifdef _WIN64 
	ConvertToShellcode(finalShellcode, finalSize, TRUE);

	std::fstream outFile = std::fstream(R"(../bin/FinalShellcode_x64.bin)", std::ios::out | std::ios::binary);
#else
	ConvertToShellcode(finalShellcode, finalSize, FALSE);

	std::fstream outFile = std::fstream(R"(../bin/FinalShellcode_x86.bin)", std::ios::out | std::ios::binary);
#endif
	outFile.write(finalShellcode, finalSize);
	outFile.close();

	///
	// Set protections
	///
	SYSTEM_INFO	sysInfo = { 0 };
	GetNativeSystemInfo(&sysInfo);
	DWORD dwOldProtect1;
	BOOL bRet = VirtualProtect(finalShellcode, sysInfo.dwPageSize, PAGE_EXECUTE_READWRITE, &dwOldProtect1);
	if (!bRet)
	{
		printf("Could not set protection");
		free(finalShellcode);
		return GetLastError();
	}

	///
	// Execute shellcode
	///
	SHC shc = (SHC)(finalShellcode);

	printf("[+] Executing shell code\n");
	shc(); // Excute shellcode
	
	free(finalShellcode);
	return 0;
}